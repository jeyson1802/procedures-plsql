
SELECT ROWNUM AS NRO_REG,
       MULT.ID_MULTA AS ID_MULTA,
       MULT.ANIO || MULT.CUM AS CUM,
       
       MULT.FEC_INGRESO            AS FEC_GENERACION_CUM,
       TIPO_PROC.DESCRIPCION       AS NOM_TIPO_PROCEDEMIENTO,
       ORGR.CODIGO                 AS COD_ORGANO_RESOLUTIVO,
       ORGR.DESCRIPCION            AS NOM_ORGANO_RESOLUTIVO,
       SEDE.CODIGO                 AS COD_SEDE,
       SEDE.DESCRIPCION            AS NOM_SEDE,
       MATE.DESCRIPCION            AS NOM_MATERIA,
       SUBM.DESCRIPCION            AS NOM_SUB_MATERIA,
       MULT.NRO_EXP_ADMINISTRATIVO AS NRO_EXPEDIENTE_UNICO,
       MDET.NRO_EXP_NIVEL          AS NRO_EXPEDIENTE_ADMINISTRATIVO,
       --PRIMERA INSTANCIA
       (SELECT
              DET.NRO_RESOLUCION
         FROM T_SCOB_MULTA_DETAL DET
        INNER JOIN T_SCOB_ORGANO_RESOLUTIVO ORGA
           ON ORGA.ID_ORGANO_RESOLUTIVO = MDET.ID_ORGANO_RESOLUTIVO
        WHERE DET.ESTADO = '1'
        AND ORGA.TIPO_INSTANCIA = 1
        AND DET.ID_MULTA = MULT.ID_MULTA) NIVEL1.NRO_RESOLUCION              AS NRO_RESOL_OR, --num_resolu
       (SELECT
              TO_DATE(TO_CHAR(DET.AUDFECCREACION, 'DD/MM/YYYY'),
                      'DD/MM/YYYY')
         FROM T_SCOB_MULTA_DETAL DET
        INNER JOIN T_SCOB_ORGANO_RESOLUTIVO ORGA
           ON ORGA.ID_ORGANO_RESOLUTIVO = MDET.ID_ORGANO_RESOLUTIVO
        WHERE DET.ESTADO = '1'
        AND ORGA.TIPO_INSTANCIA = 1
        AND DET.ID_MULTA = MULT.ID_MULTA)                AS FEC_REG_OR,
       (SELECT
              DET.FEC_RESOLUCION
         FROM T_SCOB_MULTA_DETAL DET
        INNER JOIN T_SCOB_ORGANO_RESOLUTIVO ORGA
           ON ORGA.ID_ORGANO_RESOLUTIVO = MDET.ID_ORGANO_RESOLUTIVO
        WHERE DET.ESTADO = '1'
        AND ORGA.TIPO_INSTANCIA = 1
        AND DET.ID_MULTA = MULT.ID_MULTA)              AS FEC_EMI_RESOL_OR, --fec_emision
       (SELECT
              DET.FEC_NOTIFICACION_RESOLUCION
         FROM T_SCOB_MULTA_DETAL DET
        INNER JOIN T_SCOB_ORGANO_RESOLUTIVO ORGA
           ON ORGA.ID_ORGANO_RESOLUTIVO = MDET.ID_ORGANO_RESOLUTIVO
        WHERE DET.ESTADO = '1'
        AND ORGA.TIPO_INSTANCIA = 1
        AND DET.ID_MULTA = MULT.ID_MULTA) AS FEC_NOTIF_RESOL_OR, --fec_notifica
       (SELECT
              DET.FEC_ESTADO_SGTE_INSTANCIA
         FROM T_SCOB_MULTA_DETAL DET
        INNER JOIN T_SCOB_ORGANO_RESOLUTIVO ORGA
           ON ORGA.ID_ORGANO_RESOLUTIVO = MDET.ID_ORGANO_RESOLUTIVO
        WHERE DET.ESTADO = '1'
        AND ORGA.TIPO_INSTANCIA = 1
        AND DET.ID_MULTA = MULT.ID_MULTA) AS FEC_APELACION,
       (SELECT
              DET.LOGIN_USUARIO_REGISTRO
         FROM T_SCOB_MULTA_DETAL DET
        INNER JOIN T_SCOB_ORGANO_RESOLUTIVO ORGA
           ON ORGA.ID_ORGANO_RESOLUTIVO = MDET.ID_ORGANO_RESOLUTIVO
        WHERE DET.ESTADO = '1'
        AND ORGA.TIPO_INSTANCIA = 1
        AND DET.ID_MULTA = MULT.ID_MULTA) AS USU_REG_OR,
       
       scob_pk_utilitario.scob_fn_dias_laborables_neg(to_char(NIVEL1.FEC_RESOLUCION,
                                                              'DD/MM/YYYY'),
                                                      to_char(NIVEL1.FEC_REGISTRO,
                                                              'DD/MM/YYYY')) AS CANTIDAD_OR,
       --SEGUNDA INSTANCIA
       NIVEL2.NRO_RESOLUCION              AS NRO_RESOL_COMISION,
       NIVEL2.FEC_REGISTRO                AS FEC_REG_COMISION,
       NIVEL2.FEC_RESOLUCION              AS FEC_RESOL_COMISION,
       NIVEL2.FEC_NOTIFICACION_RESOLUCION AS FEC_NOTIF_RESOL_COMISION,
       NIVEL2.FEC_ESTADO_SGTE_INSTANCIA   AS FEC_REVISION,
       NIVEL2.LOGIN_USUARIO_REGISTRO      AS USU_REG_COMISION,
       
       scob_pk_utilitario.scob_fn_dias_laborables_neg(to_char(NIVEL2.FEC_RESOLUCION,
                                                              'DD/MM/YYYY'),
                                                      to_char(NIVEL2.FEC_REGISTRO,
                                                              'DD/MM/YYYY')) AS CANTIDAD_COMISION,
       --TERCERA INSTANCIA
       NIVEL3.NRO_RESOLUCION              AS NRO_RESOL_SALA,
       NIVEL3.FEC_REGISTRO                AS FEC_REG_SALA,
       NIVEL3.FEC_RESOLUCION              AS FEC_RESOL_SALA,
       NIVEL3.FEC_NOTIFICACION_RESOLUCION AS FEC_NOTIF_RESOL_SALA,
       NIVEL3.LOGIN_USUARIO_REGISTRO      AS USU_REG_SALA,
       
       scob_pk_utilitario.scob_fn_dias_laborables_neg(to_char(NIVEL3.FEC_RESOLUCION,
                                                              'DD/MM/YYYY'),
                                                      to_char(NIVEL3.FEC_REGISTRO,
                                                              'DD/MM/YYYY')) AS CANTIDAD_SALA,
       ------------------------------------------------------
       
       TIPO_MULTA.TXT_DESCRIPCION AS NOM_TIPO_MULTA, --tipo_multa
       scob_pk_expediente.SCOB_FN_DENUNCIANTES_MULTA(mdet.id_multa, 0) AS NOM_DENUNCIANTE, --denunciante
       scob_pk_expediente.SCOB_FN_DENUNCIADOS_MULTA(mdet.id_multa, 0) AS NOM_DENUNCIADO, --denunciado
       scob_pk_expediente.SCOB_FN_SANCIONADOS_MULTA(mdet.id_multa, 0) AS NOM_SANCIONADO, --sancionado
       NULL AS NOM_TIPO_DOC_SANCIONADO,
       scob_pk_expediente.SCOB_FN_SANCIONADOS_NRO_DOC(mdet.id_multa, 0) AS NRO_TIPO_DOC_SANCIONADO,
       scob_pk_expediente.SCOB_FN_SANCIONADOS_COD_INDEC(mdet.id_multa, 0) AS COD_INDECOPI_SANCIONADO,
       scob_pk_expediente.SCOB_FN_SANCIONADOS_CLAS_INDEC(mdet.id_multa, 0) AS CLASIF_SANCIONADO,
       scob_pk_expediente.SCOB_FN_SANCIONADOS_CIIU(mult.id_multa, 0) CIIU_SANCIONADO, --act_economica
       DECODE(NVL(MDET.POR_ASOCU, '0'), '0', 'No', 'Si') AS IND_ASOCU,
       NVL(MDET.POR_ASOCU, 0) AS PORCENTAJE_ASOCU,
       --CAMPOS ANTIDUMPING
       MUAN.TIPO_CAMBIO             AS TIPO_CAMBIO_DA,
       MUAN.MONTO_ANTIDUMPING       AS DERECHO_ANTIDUMPING,
       MUAN.MONTO_INTERES           AS MONTO_DA_IC,
       MUAN.MONTO_INTERES_MORATORIO AS MONTO_DA_IM,
       --
       MUAN.NRO_OFICIO_SUNAT_CODIGO || MUAN.NRO_OFICIO_SUNAT_ANIO ||
       MUAN.NRO_OFICIO_SUNAT_PREFIJO || MUAN.NRO_OFICIO_SUNAT_CORRELATIVO AS NRO_OFICIO_SUNAT,
       NRO_LIQUIDACION_CODIGO || NRO_LIQUIDACION_ANIO ||
       NRO_LIQUIDACION_CORRELATIVO AS NRO_LIQUIDACION_COBRANZA,
       PART.CODIGO AS COD_PARTIDA,
       PART.DESCRIPCION AS NOM_PARTIDA,
       --NO EXISTE EL CAMPO MEMO EN LA INTERFAZ DE ANTIDUMPING
       NRO_DUA_CODIGO || NRO_DUA_ANIO || NRO_DUA_CORRELATIVO AS NRO_DUA,
       MUAN.ID_INTENDENCIA AS COD_INTENDENCIA,
       INTE.DESCRIPCION AS NOM_INTENDENCIA,
       
       --DECODE(MUAN.NRO_LIQUIDACION_CODIGO,NULL,'',MUAN.NRO_LIQUIDACION_CODIGO ||'-'|| MUAN.NRO_LIQUIDACION_ANIO ||'/'|| MUAN.NRO_LIQUIDACION_CORRELATIVO) AS NRO_LIQUIDACION_COBRANZA2,
       DECODE(MATE.CODIGO,
              11,
              DECODE(SUBM.CODIGO,
                     21,
                     MUAN.NRO_LIQUIDACION_CODIGO || '-' ||
                     MUAN.NRO_LIQUIDACION_ANIO || '/' ||
                     MUAN.NRO_LIQUIDACION_CORRELATIVO,
                     ''),
              '') AS NRO_LIQUIDACION_COBRANZA2,
       DECODE(MATE.CODIGO,
              11,
              DECODE(SUBM.CODIGO,
                     21,
                     TO_CHAR(NIVEL2.FEC_NOTIFICACION_RESOLUCION, 'DD/MM/YYYY'),
                     ''),
              '') AS FECH_NOT_SUNAT,
       --'' AS FECH_NOT_SUNAT,
       --MUAN.MONTO_ANTIDUMPING AS MONTO_ANTIDUMPING,
       DECODE(MATE.CODIGO,
              11,
              DECODE(SUBM.CODIGO,
                     21,
                     MUAN.NRO_DUA_CODIGO || '-' || MUAN.NRO_DUA_ANIO || '-' ||
                     MUAN.NRO_DUA_CORRELATIVO,
                     ''),
              '') AS NRO_DUA2,
       --DECODE(MUAN.NRO_DUA_CODIGO,NULL,'',MUAN.NRO_DUA_CODIGO ||'-'|| MUAN.NRO_DUA_ANIO ||'-'|| MUAN.NRO_DUA_CORRELATIVO) AS NRO_DUA2,
       DECODE(MATE.CODIGO,
              11,
              DECODE(SUBM.CODIGO,
                     21,
                     PART.CODIGO || '-' || PART.DESCRIPCION,
                     ''),
              '') AS NOM_PARTIDA2,
       --PART.CODIGO||'-'||PART.DESCRIPCION AS NOM_PARTIDA2,
       --INTE.DESCRIPCION AS DESC_INTENDENCIA,
       --FIN CAMPOS ANTIDUMPING
       -----------------------------------
       
       NVL(MDET.VALOR_UIT, 0) AS VALOR_UIT,
       MULT.MONTO_UIT AS MONTO_UIT,
       MULT.MONTO_INTERES AS MONTO_IC,
       MULT.MONTO_INTERES_MORATORIO AS MONTO_INTERES_IM,
       MULT.MONTO_COSTAS AS MONTO_COSTAS,
       --
       MULT.TOTAL_AMORTIZADO        AS TOTAL_AMORTIZADO,
       MULT.TOTAL_AMORTIZADO_IC     AS TOTAL_AMORTIZADO_IC,
       MULT.TOTAL_AMORTIZADO_IM     AS TOTAL_AMORTIZADO_IM,
       MULT.TOTAL_AMORTIZADO_COSTAS AS TOTAL_AMORTIZADO_COSTAS,
       --
       MULT.SALDO AS SALDO, --saldo_capital
       MULT.SALDO_IC AS SALDO_IC,
       MULT.SALDO_IM AS SALDO_IM,
       MULT.SALDO_COSTAS AS SALDO_COSTAS,
       EST_MULTA_OR.TXT_DESCRIPCION AS NOM_ESTADO_MULTA_OR, --est_multa_resolu
       EST_DEUDA.TXT_DESCRIPCION AS NOM_ESTADO_PAGO, --est_pago_multa
       DECODE(MULT.COD_ESTADO_PAGO, '4', MULT.PORCENTAJE_DESCUENTO, NULL) AS POR_DSCTO_PAGO, --porcen_dscto_pago
       MULT.FEC_GENERACION_SEC AS FEC_GENERACION_SEC, --fec_gene_sec
       MULT.ANIO_FILE_AEC AS ANIO_FILE_AEC, --anio_file
       MULT.FEC_INGRESO_AEC AS FEC_RECEPCION_FILE,
       ARCO.CODIGO || MULT.NRO_FILE_AEC AS NRO_FILE_AEC, --nro_file
       
       MCOB.NRO_INGRESO AS NRO_INGRESO_AEC,
       EST_MULTA_COB.TXT_DESCRIPCION AS NOM_ESTADO_MULTA_COB,
       DECODE(MOTIVO_MULT.ID_MOTIVO, 0, NULL, MOTIVO_MULT.DESCRIPCION) AS NOM_MOTIVO_MULTA, --moti_multacobra
       MULT.FEC_ULT_IMPROCEDENCIA AS FEC_ULT_OBSERVACION_AEC,
       
       MULT.FEC_INGRESO_FILE AS FEC_ULT_INGRESO_AEC,
       EXPE.ANIO || EXPE.NRO_EXPEDIENTE AS NRO_EXPED_COB, --nro_expe_cobranza
       EXPE.FEC_INGRESO AS FEC_GENERACION_EXPED_COB, --fec_gen_exp_cobran
       USUA.USUARIO AS USU_GESTOR_COBRANZA, --gestor_cobranza
       MULT.FECHA_ASIG_COBRANZA AS FEC_ASIG_GESTOR_COBRANZA,
       MULT.FEC_ULT_GEN_PRECOACTIVA AS FEC_ULT_GEN_PRECOACTIVA,
       MULT.FEC_EMISION_REC AS FEC_EMISION_REC, --fec_emision_REC
       MULT.FEC_NOTIF_REC AS FEC_NOTIF_REC, --fec_notifi_REC
       DECODE(NVL(EXPE.FLG_EMBARGO, '0'), '0', 'No', 'Si') AS IND_EMBARGO,
       EST_EXP.DESCRIPCION AS NOM_ESTADO_EXPED_COB, --est_exp_cobranza
       MOTIVO_EXPE.DESCRIPCION AS NOM_MOTIVO_EXPED_COB, --moti_exp_cobranza
       EXPE.FEC_ESTADO_EXPEDIENTE AS FEC_ULT_ESTADO_EXPED_COB, --fec_est_exp_cobran
       SCOB_PK_UTILITARIO.SCOB_FN_TABLA_DET_DES(22,
                                                EXPE.COD_EXPECTATIVA_COBRO) AS NOM_EXPECTATIVA_COBRO,
       scob_pk_expediente.SCOB_FN_SANCIONADOS_REGION(mdet.id_multa, 0) AS REGION_SANCIONADO,
       
       DECODE(EXPE.ID_EXPEDIENTE,
              NULL,
              MULT.FEC_ENVIO_RIESGO,
              MULT.FEC_ENVIO_RIESGO_EXP) AS FEC_MARCA_ENVIO_INFOCORP, --(FECHA EN QUE "MARCA" PARA ENVIAR A INFOCORP)
       ARCH_CEN.NRO_ORDEN AS NRO_ENVIO_ARCHIVO, --nro_envarch_central
       ARCH_CEN.FEC_ENVIO AS FEC_ENVIO_ARCHIVO, --fec_envarch_central
       (CASE
         WHEN MULT.ESTADO_ENVIO_ARCHIVO = 2 THEN
          'ARCHIVO CENTRAL'
         WHEN MULT.ESTADO_MULTA IN (9, 10, 11, 12, 13) THEN
          'AEC'
         ELSE
          ' '
       END) AS UBI_FISICA_EXPEDIENTE,
       NULL AS COD_SITUACION_MULTA

  FROM T_SCOB_MULTA MULT
 INNER JOIN T_SCOB_MULTA_DETAL MDET
    ON MDET.ID_MULTA = MULT.ID_MULTA
   AND MDET.FLG_ACTUAL = '1'
   AND MDET.ESTADO = '1'
 INNER JOIN (SELECT DISTINCT ID_MULTA AS ID_MULTA
               FROM T_SCOB_TMP_ADMINISTRADO) ADMINISTRADO
    ON ((0 = '0' AND '0' = ADMINISTRADO.ID_MULTA) OR
       (0 <> '0' AND ADMINISTRADO.ID_MULTA = MULT.ID_MULTA))
 INNER JOIN T_SCOB_MATERIA MATE
    ON MATE.ID_MATERIA = MULT.ID_MATERIA
 INNER JOIN T_SCOB_TIPO_PROCEDIMIENTO TIPO_PROC
    ON TIPO_PROC.ID_TIPO_PROCEDIMIENTO = MATE.ID_TIPO_PROCEDIMIENTO
 INNER JOIN T_SCOB_SUBMATERIA SUBM
    ON SUBM.ID_SUBMATERIA = MULT.ID_SUB_MATERIA
 INNER JOIN T_SCOB_ORGANO_RESOLUTIVO ORGR
    ON ORGR.ID_ORGANO_RESOLUTIVO = MDET.ID_ORGANO_RESOLUTIVO
 INNER JOIN T_SCOB_SEDE SEDE
    ON SEDE.ID_SEDE = MULT.ID_SEDE
 INNER JOIN T_SCOB_TABLA_DET TIPO_MULTA
    ON TIPO_MULTA.ID_TABLA = 45 --TIPO MULTA
   AND TO_NUMBER(TIPO_MULTA.COD_INTERNO) = TO_NUMBER(MULT.FLG_TIPO_MULTA)
 INNER JOIN T_SCOB_TABLA_DET EST_DEUDA
    ON EST_DEUDA.ID_TABLA = 34 --ESTADO DEUDA PAGO
   AND TO_NUMBER(EST_DEUDA.COD_INTERNO) = MULT.COD_ESTADO_PAGO

  LEFT JOIN T_SCOB_TABLA_DET EST_MULTA_OR
    ON EST_MULTA_OR.ID_TABLA = 5 --ESTADO MULTA OR
   AND TO_NUMBER(EST_MULTA_OR.COD_INTERNO) = MDET.ESTADO_MULTA
   AND TO_NUMBER(EST_MULTA_OR.TXT_VALOR1) = 1
  LEFT JOIN T_SCOB_TABLA_DET EST_MULTA_COB
    ON EST_MULTA_COB.ID_TABLA = 5 --ESTADO MULTA COBRANZA
   AND TO_NUMBER(EST_MULTA_COB.COD_INTERNO) = MULT.ESTADO_MULTA
   AND TO_NUMBER(EST_MULTA_COB.TXT_VALOR1) = 2
  LEFT JOIN T_SCOB_AREA_COBRANZA ARCO
    ON ARCO.ID_AREA_COBRANZA = MULT.ID_AREA_COBRANZA
  LEFT JOIN T_SCOB_USUARIO USUA
    ON USUA.ID_USUARIO = MULT.ID_USUARIO_ASIG_COBRANZA
------------------------------------------------------------------------------
---INSTANCIAS
  LEFT JOIN T_SCOB_TMP_INSTANCIAS_MULTA1 NIVEL1
    ON NIVEL1.NRO_NIVEL = 1
   AND NIVEL1.ID_MULTA = MULT.ID_MULTA
  LEFT JOIN T_SCOB_TMP_INSTANCIAS_MULTA1 NIVEL2
    ON NIVEL2.NRO_NIVEL = 2
   AND NIVEL2.ID_MULTA = MULT.ID_MULTA
  LEFT JOIN T_SCOB_TMP_INSTANCIAS_MULTA1 NIVEL3
    ON NIVEL3.NRO_NIVEL = 3
   AND NIVEL3.ID_MULTA = MULT.ID_MULTA
------------------------------------------------------------------------------
  LEFT JOIN T_SCOB_MULTA_COBRANZA MCOB
    ON MCOB.ID_MULTA = MULT.ID_MULTA
   AND MCOB.FLG_ACTUAL = '1'
   AND MCOB.ESTADO = '1'

  LEFT JOIN T_SCOB_EST_MUL_COB_MOTIVO MOTIVO_MULT --motivo multa cobranza
    ON MOTIVO_MULT.ID_MOTIVO = MULT.COD_MOTIVO
  LEFT JOIN T_SCOB_EXPEDIENTE_MULTA EXMU
    ON EXMU.ID_MULTA = MULT.ID_MULTA
   AND EXMU.ESTADO = '1'
  LEFT JOIN T_SCOB_EXPEDIENTE EXPE
    ON EXPE.ID_EXPEDIENTE = EXMU.ID_EXPEDIENTE
   AND EXPE.ESTADO = '1'
  LEFT JOIN T_SCOB_EST_EXP_COB EST_EXP
    ON EST_EXP.ID_EST_EXP_COB = EXPE.ESTADO_EXPEDIENTE
  LEFT JOIN T_SCOB_EST_EXP_COB_MOTIVO MOTIVO_EXPE --motivo estado expediente
    ON MOTIVO_EXPE.ID_MOTIVO = EXPE.ID_MOTIVO
  LEFT JOIN T_SCOB_MULTA_ANTIDUMPING MUAN
    ON MUAN.ID_MULTA = MULT.ID_MULTA
   AND MUAN.ESTADO = '1'
  LEFT JOIN T_SCOB_INTENDENCIA INTE
    ON INTE.ID_INTENDENCIA = MUAN.ID_INTENDENCIA
  LEFT JOIN T_SCOB_PARTIDA PART
    ON PART.ID_PARTIDA = MUAN.ID_PARTIDA

  LEFT JOIN T_SCOB_MULTA_ARCHIVO_CENTRAL EXPED_ARCH_CEN
    ON EXPED_ARCH_CEN.ID_MULTA = MULT.ID_MULTA
   AND EXPED_ARCH_CEN.FLG_ACTUAL = '1'
   AND EXPED_ARCH_CEN.ESTADO = '1'
  LEFT JOIN T_SCOB_ARCHIVO_CENTRAL ARCH_CEN
    ON ARCH_CEN.ID_ARCHIVO_CENTRAL =
       EXPED_ARCH_CEN.ID_MULTA_ARCHIVO_CENTRAL
   AND ARCH_CEN.ESTADO = '1'

 WHERE MULT.ESTADO = '1'
   AND TO_DATE(TO_CHAR(MULT.FEC_INGRESO, 'DD/MM/YYYY'), 'DD/MM/YYYY') BETWEEN
       TO_DATE('01/02/2023', 'DD/MM/YYYY') AND
       TO_DATE('22/02/2023', 'DD/MM/YYYY')

 --ORDER BY CUM DESC
